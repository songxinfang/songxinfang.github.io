<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      转载：国产SDK | songxinfang&#39;s blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="songxinfang">
    
    

    <meta name="description" content="集成微信分享所累积的愤怒，要请齐天大圣来平复。
作者：@nixzhu
=================================
听说微信之前是支持系统分享的，后来不知道是何原因去掉了。这给开发者带来了不小的麻烦。一方面，用户对系统分享最熟悉，开发者也省心省力；另一方面，这也是唯一支持 AirDrop 的办法。
所以我猜测微信这么做的原因是为了检测和控制第三方接入，由此开发者必然受制于它的">
<meta property="og:type" content="article">
<meta property="og:title" content="转载：国产SDK | songxinfang's blog">
<meta property="og:url" content="https://songxinfang.github.io/2016/11/10/2015-09-18-monkey-king/index.html">
<meta property="og:site_name" content="songxinfang's blog">
<meta property="og:description" content="集成微信分享所累积的愤怒，要请齐天大圣来平复。
作者：@nixzhu
=================================
听说微信之前是支持系统分享的，后来不知道是何原因去掉了。这给开发者带来了不小的麻烦。一方面，用户对系统分享最熟悉，开发者也省心省力；另一方面，这也是唯一支持 AirDrop 的办法。
所以我猜测微信这么做的原因是为了检测和控制第三方接入，由此开发者必然受制于它的">
<meta property="og:image" content="https://raw.githubusercontent.com/nixzhu/MonkeyKing/master/images/system_share.png">
<meta property="og:image" content="https://github.com/nixzhu/dev-blog/raw/master/images/nixzhu_alipay.png">
<meta property="og:updated_time" content="2016-11-10T01:47:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="转载：国产SDK | songxinfang's blog">
<meta name="twitter:description" content="集成微信分享所累积的愤怒，要请齐天大圣来平复。
作者：@nixzhu
=================================
听说微信之前是支持系统分享的，后来不知道是何原因去掉了。这给开发者带来了不小的麻烦。一方面，用户对系统分享最熟悉，开发者也省心省力；另一方面，这也是唯一支持 AirDrop 的办法。
所以我猜测微信这么做的原因是为了检测和控制第三方接入，由此开发者必然受制于它的">
<meta name="twitter:image" content="https://raw.githubusercontent.com/nixzhu/MonkeyKing/master/images/system_share.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">songxinfang&#39;s blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          learning work communicate
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">转载：国产SDK</h1>

    

    <div class="post-meta">
      <time datetime="2016-11-10" class="post-meta__date date">2016-11-10</time> 

      <span class="post-meta__tags tags">

          

          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>集成微信分享所累积的愤怒，要请齐天大圣来平复。</p>
<p>作者：<a href="https://twitter.com/nixzhu" target="_blank" rel="external">@nixzhu</a></p>
<p>=================================</p>
<p>听说微信之前是支持系统分享的，后来不知道是何原因去掉了。这给开发者带来了不小的麻烦。一方面，用户对系统分享最熟悉，开发者也省心省力；另一方面，这也是唯一支持 AirDrop 的办法。</p>
<p>所以我猜测微信这么做的原因是为了检测和控制第三方接入，由此开发者必然受制于它的SDK。而且在自己的应用里集成一个不开源的SDK，心里多少都会不愉快，谁知道它会在后面干什么呢？</p>
<p>首先就看看微信的 SDK 有没有 CocoaPods：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pod search wechat</div></pre></td></tr></table></figure>
<p>结果有不少，我选择了 WeixinSDK 1.4.3，那就将其放到项目的 <code>podfile</code> 里安装好。</p>
<p>因为目前我们的项目使用 Swift 1.2，于是在<code>*-Bridging-Header.h</code>里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#import &quot;WXApi.h&quot;</div></pre></td></tr></table></figure>
<p>这个头文件给人一种恶心的感觉！但也没有办法，试试编译。结果run不过去。一看，WeixinSDK 的两个头文件之一的 <code>WXApiObject.h</code> 里用了 UIImage，可它居然不引用 <code>UIKit/UIKit.h</code>，心中升起莫名的怒火。也许它们是为了打包方便，但这是一种极其不尊重第三方开发者的行为。</p>
<p>那好，我手动在<code>*-Bridging-Header.h</code>里多加一句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line">#import &quot;WXApi.h&quot;</div></pre></td></tr></table></figure>
<p>成功通过编译。</p>
<p>那就先来测试一下，按照其几乎无法目睹的文档：</p>
<ol>
<li>先添加 CFBundleURLTypes，……，便于回调</li>
<li>再在 appDelegate 的 didFinishLauching 里 <code>WXApi.registerApp(&quot;appID...&quot;)</code>，心中更怒了，为何要在这么早注册它的 appID，我还没打算分享呢。后来百度LBS的李择一说光是这一句，微信SDK就在后面做数据收集了，它会往<a href="http://pingma.qq.com/mstat/report" target="_blank" rel="external">http://pingma.qq.com/mstat/report</a>发送RC4加密的数据。鬼才知道它还会干什么！</li>
<li><p>测试分享链接：</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> sendMessageRequest = <span class="type">SendMessageToWXReq</span>()</div><div class="line"></div><div class="line">sendMessageRequest.scene = <span class="number">1</span> <span class="comment">// 朋友圈</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> message = <span class="type">WXMediaMessage</span>()</div><div class="line">message.title = <span class="string">"Test"</span></div><div class="line">message.description = <span class="string">"test share apple.com"</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> webObject = <span class="type">WXWebpageObject</span>()</div><div class="line">webObject.webpageUrl = <span class="string">"http://www.apple.com"</span></div><div class="line">message.mediaObject = webObject</div><div class="line"></div><div class="line">sendMessageRequest.message = message</div><div class="line"></div><div class="line"><span class="type">WXApi</span>.sendReq(sendMessageRequest)</div></pre></td></tr></table></figure>
</li>
<li><p>如果要处理微信的回调，还得在 appDelegate 里添加：</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication, handleOpenURL url: NSURL)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">WXApi</span>.handleOpenURL(url, delegate: <span class="keyword">self</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication, openURL url: NSURL, sourceApplication: String?, annotation: AnyObject?)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">WXApi</span>.handleOpenURL(url, delegate: <span class="keyword">self</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 鬼才知道它会不会在 handleOpenURL 时收集数据啊！</p>
</li>
</ol>
<p>通常，第 3 步时还要检查 <code>WXApi.isWXAppInstalled()</code> 和 <code>WXApi.isWXAppSupportApi()</code>，可我发现，在测试机已安装了微信的前提下，前者可能返回 false，后者返回 true，我已经出离愤怒了。也许微信后台还有激活时间段？后来过了几个小时，这两个方法都返回 true 了，但谁也不知道中间发生了什么。</p>
<p>最后，为了使用 UIActivityController 来做系统分享，我们还必须制作 UIActivity，可微信的分享还分成 Session（聊天） 和 Timeline（朋友圈），它一个破 App 居然要占据两个位置。</p>
<p>还好这并不是很困难的事情：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeChatActivity</span>: <span class="title">UIActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Scene</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> <span class="type">Session</span>    <span class="comment">// 聊天界面</span></div><div class="line">        <span class="keyword">case</span> <span class="type">Timeline</span>   <span class="comment">// 朋友圈</span></div><div class="line"></div><div class="line">        <span class="keyword">var</span> value: <span class="type">Int32</span> &#123;</div><div class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="type">Session</span>:</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span></div><div class="line">            <span class="keyword">case</span> <span class="type">Timeline</span>:</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> activityType: <span class="type">String</span> &#123;</div><div class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="type">Session</span>:</div><div class="line">                <span class="keyword">return</span> <span class="string">"xxx.shareToWeChatSession"</span></div><div class="line">            <span class="keyword">case</span> <span class="type">Timeline</span>:</div><div class="line">                <span class="keyword">return</span> <span class="string">"xxx.shareToWeChatTimeline"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> activityTitle: <span class="type">String</span> &#123;</div><div class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="type">Session</span>:</div><div class="line">                <span class="keyword">return</span> <span class="type">NSLocalizedString</span>(<span class="string">"WeChat Session"</span>, comment: <span class="string">""</span>)</div><div class="line">            <span class="keyword">case</span> <span class="type">Timeline</span>:</div><div class="line">                <span class="keyword">return</span> <span class="type">NSLocalizedString</span>(<span class="string">"WeChat Timeline"</span>, comment: <span class="string">""</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> activityImage: <span class="type">UIImage</span>? &#123;</div><div class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="type">Session</span>:</div><div class="line">                <span class="keyword">return</span> <span class="type">UIImage</span>(named: <span class="string">"wechat_session"</span>)</div><div class="line">            <span class="keyword">case</span> <span class="type">Timeline</span>:</div><div class="line">                <span class="keyword">return</span> <span class="type">UIImage</span>(named: <span class="string">"wechat_timeline"</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Message</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> title: <span class="type">String</span>?</div><div class="line">        <span class="keyword">let</span> description: <span class="type">String</span>?</div><div class="line">        <span class="keyword">let</span> thumbnail: <span class="type">UIImage</span>?</div><div class="line"></div><div class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">Media</span> </span>&#123;</div><div class="line">            <span class="keyword">case</span> <span class="type">URL</span>(<span class="type">NSURL</span>)</div><div class="line">            <span class="keyword">case</span> <span class="type">Image</span>(<span class="type">UIImage</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">let</span> media: <span class="type">Media</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> scene: <span class="type">Scene</span></div><div class="line">    <span class="keyword">let</span> message: <span class="type">Message</span></div><div class="line"></div><div class="line">    <span class="keyword">init</span>(scene: <span class="type">Scene</span>, message: <span class="type">Message</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.scene = scene</div><div class="line">        <span class="keyword">self</span>.message = message</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">activityCategory</span>() -&gt; <span class="title">UIActivityCategory</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> .<span class="type">Share</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">activityType</span><span class="params">()</span></span> -&gt; <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">return</span> scene.activityType</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">activityTitle</span><span class="params">()</span></span> -&gt; <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">return</span> scene.activityTitle</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">activityImage</span><span class="params">()</span></span> -&gt; <span class="type">UIImage</span>? &#123;</div><div class="line">        <span class="keyword">return</span> scene.activityImage</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">canPerformWithActivityItems</span><span class="params">(activityItems: [AnyObject])</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> <span class="type">WXApi</span>.isWXAppInstalled() &amp;&amp; <span class="type">WXApi</span>.isWXAppSupportApi() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">performActivity</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">let</span> request = <span class="type">SendMessageToWXReq</span>()</div><div class="line"></div><div class="line">        request.scene = scene.value</div><div class="line"></div><div class="line">        <span class="keyword">let</span> message = <span class="type">WXMediaMessage</span>()</div><div class="line"></div><div class="line">        message.title = <span class="keyword">self</span>.message.title</div><div class="line">        message.description = <span class="keyword">self</span>.message.description</div><div class="line">        message.setThumbImage(<span class="keyword">self</span>.message.thumbnail)</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.message.media &#123;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> .<span class="type">URL</span>(<span class="keyword">let</span> <span class="type">URL</span>):</div><div class="line">            <span class="keyword">let</span> webObject = <span class="type">WXWebpageObject</span>()</div><div class="line">            webObject.webpageUrl = <span class="type">URL</span>.absoluteString!</div><div class="line">            message.mediaObject = webObject</div><div class="line"></div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> image):</div><div class="line">            <span class="keyword">let</span> imageObject = <span class="type">WXImageObject</span>()</div><div class="line">            imageObject.imageData = <span class="type">UIImageJPEGRepresentation</span>(image, <span class="number">1</span>)</div><div class="line">            message.mediaObject = imageObject</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        request.message = message</div><div class="line"></div><div class="line">        <span class="type">WXApi</span>.sendReq(request)</div><div class="line"></div><div class="line">        activityDidFinish(<span class="literal">true</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之后使用时就可以放到 UIActivityViewController 里了，当然，还得请设计师画两个图标。</p>
<p><img src="https://raw.githubusercontent.com/nixzhu/MonkeyKing/master/images/system_share.png" alt="系统分享微信"></p>
<p>事情到这一步好像就结束了，但我心中的愤怒丝毫没有减少。</p>
<p>第二天，<a href="http://weibo.com/u/1783821582" target="_blank" rel="external">Limon</a>提到一个开源项目：<a href="https://github.com/100apps/openshare" target="_blank" rel="external">openshare</a>，不用那些第三方不开源的SDK即可做到分享或登录等操作，我心中很是激动！</p>
<p>作为一种研究，我决定分析 <a href="https://github.com/100apps/openshare" target="_blank" rel="external">openshare</a> 的实现（作者已写了很好的<a href="http://www.gfzj.us/series/openshare/" target="_blank" rel="external">文章</a>），然后用 Swift 写一个支持分享到微信的功能即可，这也是目前我们应用只用到的部分。</p>
<p><a href="https://github.com/100apps/openshare" target="_blank" rel="external">openshare</a> 的原理很简单，分析第三方 SDK 在分享跳转时所传递的数据然后自行构造同样的数据流。虽说原理简单，但想必作者花了不少时间调试和测试。</p>
<p>简单来说，走微信分享时，我们要用微信的 scheme 打开它，这个 URL 里有不少参数，比较大的数据，比如分享图片时的图片要放在系统粘贴板里，因为系统粘贴板是所有应用都可以访问的。</p>
<p>其它细节就不赘述了。不过我发现，相对来说，微信的机制比 QQ 好一点，微信利用的 PropertyList 来做数据交换，比较好格式化；而 QQ 可能比较原始，要在 URL 里编码大量数据。虽说目的都一样，但过程的体验不同。</p>
<p>最后得到一个开源项目：<a href="https://github.com/nixzhu/MonkeyKing" target="_blank" rel="external">MonkeyKing</a>，以 Swift 2 编写。它目前支持分享文字、链接和图片到微信或 QQ，也支持 OAuth。若你有其它需求（如支付），还是请考虑 <a href="https://github.com/100apps/openshare" target="_blank" rel="external">openshare</a>。由此，我们就避免了使用微信的 SDK 带来的愤怒，也避免了用户所要面临的不必要的风险。</p>
<p>不过 <a href="https://github.com/nixzhu/MonkeyKing" target="_blank" rel="external">MonkeyKing</a> 的代码用了不少 Swift 的特性，你若想看实现的细节会比较容易些。</p>
<p>最后我想说，国产SDK的安全性在不开源的情况下几乎没有任何保障。大家能避免使用的时候就尽量避免，能延迟调用的API都尽量延迟（例如<code>WXApi.registerApp(&quot;appID...&quot;)</code>），产品经理也要考虑自己负责的 App 是否需要集成第三方的登录功能（有的 App 真的不需要做一个用户系统，反而受制于人）。</p>
<p>还要加一句，微信的公众号绝对违反万维网的互联精神，任其做大，后患无穷。该独立的时候还请保持独立。</p>
<p>===============</p>
<p>欢迎转载，但请一定注明出处！ <a href="https://github.com/nixzhu/dev-blog" target="_blank" rel="external">https://github.com/nixzhu/dev-blog</a></p>
<p>欢迎转发此条 Tweet <a href="https://twitter.com/nixzhu/status/644703031091552256" target="_blank" rel="external">https://twitter.com/nixzhu/status/644703031091552256</a> 或微博 <a href="http://weibo.com/2076580237/CB51o5Zke" target="_blank" rel="external">http://weibo.com/2076580237/CB51o5Zke</a>  以分享此文！</p>
<p>如果你认为这篇文章不错，也有闲钱，那你可以用支付宝扫描下方二维码随便捐助一点，以慰劳作者的辛苦：</p>
<p><img src="https://github.com/nixzhu/dev-blog/raw/master/images/nixzhu_alipay.png" alt="nixzhu的支付宝二维码"></p>

  </section>

  
  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
